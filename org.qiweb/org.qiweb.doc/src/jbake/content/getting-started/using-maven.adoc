
== Using Maven

=== Create a new application

To create a new QiWeb application based on Maven, use the following command:

[source,bash]
----
git archive --format=tar --prefix=YOUR_APP_NAME/ --remote=git@scm.codeartisans.org:qiweb/qiweb-skel-maven.git GIT_REF | tar -xf -
----

Where `YOUR_APP_NAME` is, well, your application name.
A directory with this name will be created with the new application in it.

And where `GIT_REF` is the version of the application skeleton you want to use.
You'll use:

- `master` to get the latest stable version ;
- `develop` to get the latest development version ;
- or a version identifier to get a specific version.

[IMPORTANT]
.What is this horrible command?
====
What the 'horrible' command above does is to export the content of a git repository at a given reference to a directory
of your choice without creating a clone.
In other words, it simply downloads the content of a git repository at a given reference.

A command line client for easy usage of application skeletons is under active discussion, planned and will be added in
a future release.

For the time being, you'll have to copy/paste/edit, or type, this horrible command :)
====


=== Run in development mode

To run a QiWeb application in development mode, use the `devshell` Maven goal:

[source]
----
mvn org.qiweb:org.qiweb.maven:devshell
 _____ _ _ _ _     _      ____          _____ _       _ _
|     |_| | | |___| |_   |    \ ___ _ _|   __| |_ ___| | |
|  |  | | | | | -_| . |  |  |  | -_| | |__   |   | -_| | |
|__  _|_|_____|___|___|  |____/|___|\_/|_____|_|_|___|_|_|
   |__|

Loading...
Compiling Application...
>> QiWeb DevShell starting...
>> Ready for requests on http(s)://127.0.0.1:23023!
----

// TIP: If you want to change the listening address and port override `qiweb.http.address` and `qiweb.http.port` either
// through the command line by adding `-Dqiweb.http.address=0.0.0.0` and `-Dqiweb.http.port=80` for example ; or in the
// `application.conf` file.

You can now open your browser to http://localhost:23023/ to see the welcome page.

image::images/welcome.png[Welcome,640]

[TIP]
====
In production mode, you need an application's secret.
This secret is a key used for cypher and signature operations, it must be unique per application.
Its place is in the application configuration, see `./src/main/resources/application.conf`.
One can generate a new random secret using the `secret` Maven goal:

    mvn org.qiweb:org.qiweb.maven:secret

It is easily appended to the `application.conf` file this way:

    mvn -q org.qiweb:org.qiweb.maven:secret >> ./src/main/resources/application.conf

Once you have properly set your application's secret, use the `start` Maven goal to run your application in production mode:

    mvn org.qiweb:org.qiweb.maven:start
====




=== Application Walkthrough

The newly created application has a single HTTP route:

.`./src/main/resources/routes.conf`
[source,routes]
----
GET / controllers.Application.index
----

That points to this controller method:

.`./src/main/java/controllers/Application.java`
[source,java]
----
public Outcome index()
{
    return outcomes().ok( "Hello QiWeb" ).build();
}
----

[IMPORTANT]
.Every QiWeb application needs a secret
====
This secret is a key used for cypher and signature operations, it must be unique per application.
Its place is in the application configuration, see `./src/main/resources/application.conf`.
====

Here is the project tree:

    ├── src
    │   └── main
    │       ├── java
    │       │   └── controllers
    │       │       └── Application.java            <= Controller Java Class
    │       └── resources
    │           ├── application.conf                <= Application Configuration
    │           └── routes.conf                     <= Routes
    │
    └── pom.xml                                     <= Maven build file

You can see that applications generated by `qiweb` follow the well known maven directory tree convention.
Yes, it could have simplified things a bit to simply use `src`, `app` or `conf` directory names but this way it's
damn easy to add a Gradle or Maven build to such an application.

At the bottom of the tree you can see the Maven build file.
Here is what you'll find inside:

// TODO XML is not correctly rendered if ["source","xml",subs="attributes"] is used ... FIXME!
.`./pom.xml`
[source,xml]
----
<?xml version="1.0"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>hello-qiweb</groupId>
    <artifactId>hello-qiweb</artifactId>
    <version>1.0-SNAPSHOT</version>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
    </properties>

    <repositories>
        <repository>
            <id>qiwebRepo</id>
            <url>https://repo.codeartisans.org/qiweb</url>
        </repository>
    </repositories>

    <dependencies>
        <dependency>
            <groupId>org.qiweb</groupId>
            <artifactId>org.qiweb.api</artifactId>
            <version>{qiweb_version}</version>
        </dependency>
        <dependency>
            <groupId>org.qiweb</groupId>
            <artifactId>org.qiweb.server.bootstrap</artifactId>
            <version>{qiweb_version}</version>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.qiweb</groupId>
            <artifactId>org.qiweb.test</artifactId>
            <version>{qiweb_version}</version>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <pluginRepositories>
        <pluginRepository>
            <id>qiwebRepo</id>
            <url>https://repo.codeartisans.org/qiweb</url>
        </pluginRepository>
    </pluginRepositories>

    <build>
        <plugins>
            <plugin>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.1</version>
                <configuration>
                    <source>1.8</source>
                    <target>1.8</target>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.qiweb</groupId>
                <artifactId>org.qiweb.maven</artifactId>
                <version>{qiweb_version}</version>
            </plugin>
        </plugins>
    </build>

</project>
----

TIP: See the link:guides.html#maven_plugin[QiWeb Maven Plugin guide] for more insights.

