
=== Introduction

QiWeb is a HTTP development kit.
QiWeb is not a full stack framework.

In other words, QiWeb don't compell you to use any persistence mechanism nor templating engine.
You are free to choose whatever may suit your needs.

image::images/overview.png[Overview,640]


=== Application Structure

A QiWeb Application is nothing but a plain old Java program.
The framework provide a default `main` class/method for you to reuse but you can also write yours if you need it.
The minimal requirement is a configuration file named `application.conf` containing a `app.secret` entry.


=== Logging

QiWeb use the http://www.slf4j.org[SLF4J] API (Simple Logging Facade for Java) but you have to choose what SLF4J
implementation to use.
We strongly recommend http://logback.qos.ch/[Logback].
You have full control on logging configuration.

All QiWeb loggers are present in the `org.qiweb` namespace according to code packages.
Here are the most useful:

- `org.qiweb.runtime.server` QiWeb Http Server
- `org.qiweb.runtime.routes` QiWeb Http Router
- `org.qiweb.runtime.controllers` QiWeb Controller
- `org.qiweb.runtime.filters` QiWeb Controller Filters
- etc...


=== Character encoding

By default all character encoding is done in UTF-8.
Character encoding can be changed by setting the `qiweb.character-encoding` configuration property.

QiWeb ignore the runtime platform default encoding and complies to its configuration only.
This is the only way to get a consistent behaviour accross different environments and prevent
https://en.wikipedia.org/wiki/Mojibake[mojibakes].

CAUTION: Even tough QiWeb does its best to ensure uniform character encoding for your application, you may use libraries
that don't.
In such a case you should http://stackoverflow.com/questions/361975/setting-the-default-java-character-encoding[set the
default Java character encoding] using the `file.encoding` system property.

All QiWeb APIs allows you to override character encoding when relevant.


=== Configuration

INFO: QiWeb configuration use the https://github.com/typesafehub/config/blob/master/HOCON.md[HOCON format] ("Human
Optimized Config Object Notation"). It is parsed using https://github.com/typesafehub/config[Typesafe Config].

The `application.conf` file must be present at the root of your classpath and must at least contain one single entry:
`app.secret` which is the secret key your application will use to sign session cookies.
For all other configuration properties, the QiWeb Runtime provide a `reference.conf` file that the Config library
automatically loads.
You can of course override all theses configuration properties in your `application.conf` file.

If you need to add configuration properties for your application you are encouraged to do so in your `application.conf`
file.

All configuration properties are available to your controllers and filters via the Context object.

[source,java]
----
import static org.qiweb.api.controllers.Controller.*;
public MyController {
  public Outcome aControllerMethod() {
    String configValue = application().config().getString("your.custom.config.key");
    // Do what you have to do according to the configuration value
    return outcomes().ok("whatever").build();
  }
}
----

All configuration properties can be overriden by defining System Properties.
This means that you can easily provide all configuration on the command line.

IMPORTANT: Every system property is also present in the configuration.
For example, the `java.home` System Property is automatically present in the configuration at the `java.home` key.
In other words, and if you need it, keep in mind that you can use configuration properties from the command line without
defining a default value in any configuration file.

Moreover, some special System Properties allow to use an alternate config file:

- `config.resource` to load configuration from the classpath
- `config.file` to load configuration from the filesystem
- `config.url` to load configuration from an URL

Note that this will replace the `application.conf` file, not add to it.
You still can leverage the inclusion mechanism of HOCON to include your `application.conf` file from the one you
specified using one of the System Properties described above.


=== Lifecycle

==== Startup explained

==== Shutdown explained

Shutting your application down gracefully is as critical as running it.

When shut down is requested (Ctrl-C, kill command etc...) the runtime is put in shutting down state for a maximum
amount of time defined by the `qiweb.shutdown.timeout` configuration property that default to 5 seconds.
Obviously, if there are no requests to process your application will shutdown immediatly.

While shutting down, your application will continue to serve running requests till they complete.
Clients using HTTP 1.1 Keep-Alive will see your application respond with a `Connection` header with `Close` value and
effectively close the connection.

Moreover, your application will respond to new incoming requests with a `503 Service Unavailable` status.
You can set the `qiweb.shutdown.retry-after` configuration property so that a `Retry-After` header is added to theses
responses.

If your application is running on multiple nodes behind a balancer you can lower this value to 0, yes *zero*, allowing
your clients to reconnect immediatly to another node. Pretty useful for zero-downtime upgrades.


==== The Global object

==== Instanciation

- Controllers
- Filters

==== Invocation

- Controllers
- Filters


=== Routes

Routes are defined by:

- a HTTP method ;
- a path expression ;
- a fully qualified method name ;
- optionaly a method parameters definition ;
- and finaly optional modifiers.

Teh default QiWeb router allows for textual representation of routes definition.

    http-method path-expression controller-fqcn.method-name[(parameters)] [modifiers]

You can also express routes definitions in code using the Routes API.

Request URI Path and QueryString are the source of Controller Parameters.


NOTE: URI Fragment identifier is considered as useful only on the client side and hence is not taken into account when
routing.
However, the reverse routing API allow you to append a fragment identifier to generated URIs.


=== Controllers


=== Outcomes


=== Filters


=== Session

As QiWeb is stateless oriented, it provides no way to keep session state server side.
Instead a simple session Cookie is used to keep state accross user requests.

The Session Cookie contains a `Map<String,String>` and is signed using the mandatory Application Secret.
Signature use the HmacSHA1 algorithm.


=== Cookies


=== Forms & Uploads


=== WebSockets

=== SSL

=== Query String

// TODO put intro, ??? wikipedia ???? build plugin to fetch wikipedia and update ???

[source,java]
----
import static org.qiweb.api.controllers.Controller.*;
public MyController {
  public Outcome aControllerMethod() {
    String singleFoo = request().queryString().singleValueOf("foo");
    // Do what you have to do according to the foo value
    return outcomes().ok("whatever").build();
  }
}
----


==== Multiple values

Query strings can contain multiple values for the same parameter.
How this is handled is not stated in the HTTP 1.0 nor 1.1 RFCs and, by so, open to interpretation.
You, and others, are free to do it the way you, or they, want.
This while being conform to the HTTP protocol.
See https://www.owasp.org/images/b/ba/AppsecEU09_CarettoniDiPaola_v0.8.pdf[HTTP Parameter Pollution, 2009] at OWASP.

Frameworks usually handle this in their own each way.
When using one framework you get used to its way of doing things ovelooking the fact that you can get powned in pretty
silly ways.
See the OWASP paper cited above for numerous examples.

QiWeb, like other frameworks, has a default behaviour.
It's a bit simple, but this is for good.
No multi-value parameters is allowed.
A request coming with multiple values (eg. `foo=bar&foo=baz`) is, by default, rejected with a `400 Bad Request` status
and a warning is logged.

// TODO In dev-mode, put meta-data in exceptions with pointers to documentation!!!

On the other hand, and if you really need it, you can easily enable multiple values support by setting the
`qiweb.http.query-string.multi-valued` to yes.

TIP: Did you take a look at the OWASP link mentioned earlier? No? Now is a good time.

When enabled, `foo=bar&foo=baz` is accepted and your application code can access the values easily:

[source,java]
----
import static org.qiweb.api.controllers.Controller.*;
public MyController {
  public Outcome aControllerMethod() {
    String singleFoo        = request().queryString().singleValueOf("foo"); <1>
    List<String> allFoos    = request().queryString().valuesOf("foo");      <2>
    String firstFoo         = request().queryString().firstValueOf("foo");  <3>
    String lastFoo          = request().queryString().lastValueOf("foo");   <4>
    // Do what you have to do according to the foo values
    return outcomes().ok("whatever").build();
  }
}
----
1. Get a single value, throws if there are multiple values
2. Get all values
3. Get first value
4. Get last value

The `QueryString` API leave you in control regarding which value you want to use.

NOTE: Enabling `qiweb.http.query-string.multi-valued` do not enable any *syntax*. A request with multiple `foo[]`
values will pass but the values will be in the `"foo[]"` parameter, not `"foo"`. Be careful, there's no magic.


