<!doctype html>
<html>
    <head>
        <title>Modules</title>
        <style>
            html,body {
                margin:0; padding:0;
            }
            #dyndoc-menu {
                margin: 0; padding: 0;
                border: 1px solid black;
                border-bottom: 1px solid gray;
            }
            #dyndoc-menu, #dyndoc-menu * {
                background-color: black;
                color: lightgrey;
            }
            #dyndoc-menu .active {
                color: yellow;
            }
            #dyndoc-body {
                margin: 0; padding: 0;
            }
        </style>
    </head>
    <body>
        <div id="dyndoc-menu">
            <ul>
                <!--
                <li><a href="jdbc">JDBC Module</a></li>
                <li><a href="jndi">JNDI Module</a></li>
                -->
                <!-- MENU -->
            </ul>
        </div>
        <div id="dyndoc-body"></div>
        <!--
        <script type="text/javascript" src="jquery-2.1.1.min.js"></script>
        <script type="text/javascript" src="jquery.history.js"></script>
        -->
        <script type="text/javascript">
            // JQUERY
        </script>
        <script type="text/javascript">
            // HISTORY.JS
        </script>
        <script type="text/javascript">
            $(document).ready(function() {
                // Utility functions
                function canonicalize(url) {
                    var div = document.createElement('div');
                    div.innerHTML = "<a></a>";
                    div.firstChild.href = url; // Ensures that the href is properly escaped
                    div.innerHTML = div.innerHTML; // Run the current innerHTML back through the parser
                    return div.firstChild.href;
                }
                function removeTrailingSlash(input) {
                    if (input.lastIndexOf('/') === input.length - 1)
                        return input.substring(0, input.length - 1);
                    return input;
                }

                // Original URL
                var originalLocation = removeTrailingSlash(window.location.href);
                console.log("Original Location: " + originalLocation);

                // Menu Links
                var $menu_links = $("#dyndoc-menu a");
                $menu_links.each(function(index, link) {
                    var $link = $(link);
                    $link.attr('href', canonicalize(originalLocation + '/' + $link.attr('href')));
                });
                $menu_links.click(function() {
                    History.pushState({}, "Module Doc Title", this.href);
                    return false;
                });

                // History handling
                History.Adapter.bind(window, 'statechange', function() {

                    // Gather state data
                    var state = History.getState();
                    // console.log(state);
                    var newLocation = canonicalize(removeTrailingSlash(state.url));
                    var newScroll = state.data.scroll;

                    // Empty container
                    var $dyndocBody = $("#dyndoc-body");
                    $dyndocBody.empty();

                    // Activate menu item
                    $menu_links.removeClass('active');
                    $menu_links.each(function(index, link) {
                        if (newLocation.indexOf(link.href) === 0)
                            $(link).addClass('active');
                    });

                    // Load new content into container if not on home
                    if (newLocation !== originalLocation) {
                        console.log("Will Load: " + newLocation);
                        $dyndocBody.load(newLocation, function() {
                            console.log("Loaded!");
                            // Eventually scroll to anchor
                            if (newScroll) {
                                $('html, body').animate({scrollTop: $("#" + newScroll).offset().top}, 0);
                                window.location.hash = '#' + newScroll;
                            }
                            // Now manipulate links in loaded content
                            $("#dyndoc-body a").each(function(index, link) {
                                var $link = $(link);
                                var href = $link.attr('href');
                                if (href) {
                                    if (href.indexOf('http://') === 0 || href.indexOf('https://') === 0 || href.indexOf('//') === 0) {
                                        // Loaded external links
                                        $link.attr('target', '_blank').append('<sup>^</sup>');
                                    } else {
                                        // Loaded internal links
                                        $link.attr('href', canonicalize(newLocation + '/' + href));
                                        $link.click(function() {
                                            console.log(this);
                                            var load;
                                            var data = {};
                                            if (this.href.indexOf('#') === -1) {
                                                load = removeTrailingSlash(this.href);
                                            } else {
                                                load = removeTrailingSlash(this.href.substring(0, this.href.indexOf('#')));
                                                data.scroll = this.href.substring(this.href.indexOf('#') + 1);
                                            }
                                            console.log("Internal link clicked: " + load + '#' + data.scroll);
                                            History.pushState(data, "Module Doc Title", load);
                                            return false;
                                        });
                                    }
                                }
                            });
                        });
                    }
                });
            });
        </script>
    </body>
</html>
